<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fatura Takip</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
<div id="app" class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Fatura Takip Sistemi</h2>
    <div>
      <button @click="fetchFaturas" class="btn btn-outline-primary me-2">Yenile 🔄</button>
      <button class="btn btn-success" @click="resetForm()">+ Yeni Fatura</button>
    </div>
  </div>

  <div class="card p-4 mb-4" v-if="showForm">
    <h5>{{ editMode ? 'Faturayı Güncelle' : 'Yeni Fatura Ekle' }}</h5>
    <form @submit.prevent="submitForm">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Ürün No</label>
          <input type="text" class="form-control" v-model="form.productNumber" required />
        </div>
        <div class="col-md-4">
          <label class="form-label">Ürün Adı</label>
          <input type="text" class="form-control" v-model="form.productName" required />
        </div>
        <div class="col-md-2">
          <label class="form-label">Adet</label>
          <input type="number" class="form-control" v-model="form.count" required />
        </div>
        <div class="col-md-2">
          <label class="form-label">Birim</label>
          <input type="text" class="form-control" v-model="form.unit" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Birim Fiyatı</label>
          <input type="number" step="0.01" class="form-control" v-model="form.unitPrice" required />
        </div>
        <div class="col-md-3">
          <label class="form-label">Toplam Tutar</label>
          <input type="number" step="0.01" class="form-control" v-model="form.totalAmount" :readonly="true" />
        </div>
      </div>

      <div class="mt-3">
        <button type="submit" class="btn btn-primary me-2">
          {{ editMode ? 'Güncelle' : 'Kaydet' }}
        </button>
        <button @click="cancelEdit" type="button" class="btn btn-secondary">İptal</button>
      </div>
    </form>
  </div>

  <table class="table table-bordered table-hover align-middle text-center">
    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>Ürün No</th>
        <th>Ürün Adı</th>
        <th>Adet</th>
        <th>Birim</th>
        <th>Birim Fiyatı</th>
        <th>Toplam</th>
        <th>İşlemler</th>
      </tr>
    </thead>
    <tbody>
      <tr v-for="fatura in faturalar" :key="fatura.id">
        <td>{{ fatura.id }}</td>
        <td>{{ fatura.productNumber }}</td>
        <td>{{ fatura.productName }}</td>
        <td>{{ fatura.count }}</td>
        <td>{{ fatura.unit }}</td>
        <td>{{ fatura.unitPrice }}</td>
        <td>{{ fatura.totalAmount }}</td>
        <td>
          <button class="btn btn-sm btn-warning me-1" @click="editFatura(fatura)">✏️</button>
          <button class="btn btn-sm btn-danger" @click="deleteFatura(fatura.id)">🗑️</button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<script>
const { createApp, ref, onMounted, watch } = Vue;

createApp({
  setup() {
    const apiUrl = 'http://localhost:8084/api/faturas';
    const faturalar = ref([]);
    const showForm = ref(false);
    const editMode = ref(false);
    const editingId = ref(null);
    const form = ref({
      productNumber: '',
      productName: '',
      count: 1,
      unit: '',
      unitPrice: 0,
      totalAmount: 0
    });

    const fetchFaturas = async () => {
      try {
        const res = await fetch(apiUrl);
        faturalar.value = await res.json();
      } catch (err) {
        alert("Veriler alınamadı: " + err.message);
      }
    };

    const submitForm = async () => {
      form.value.totalAmount = form.value.count * form.value.unitPrice;

      const method = editMode.value ? 'PUT' : 'POST';
      const endpoint = editMode.value ? `${apiUrl}/${editingId.value}` : `${apiUrl}/addFatura`;

      try {
        const res = await fetch(endpoint, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(form.value)
        });

        if (!res.ok) throw new Error(await res.text());

        await fetchFaturas();
        resetForm();
      } catch (err) {
        alert("İşlem hatası: " + err.message);
      }
    };

    const deleteFatura = async (id) => {
      if (!confirm("Bu faturayı silmek istediğinizden emin misiniz?")) return;

      try {
        const res = await fetch(`${apiUrl}/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error(await res.text());
        await fetchFaturas();
      } catch (err) {
        alert("Silme hatası: " + err.message);
      }
    };

    const editFatura = (fatura) => {
      form.value = { ...fatura };
      editingId.value = fatura.id;
      editMode.value = true;
      showForm.value = true;
    };

    const resetForm = () => {
      form.value = {
        productNumber: '',
        productName: '',
        count: 1,
        unit: '',
        unitPrice: 0,
        totalAmount: 0
      };
      editingId.value = null;
      editMode.value = false;
      showForm.value = true;
    };

    const cancelEdit = () => {
      resetForm();
      showForm.value = false;
    };

    watch(() => [form.value.count, form.value.unitPrice], () => {
      form.value.totalAmount = form.value.count * form.value.unitPrice;
    });

    onMounted(fetchFaturas);

    return {
      faturalar,
      form,
      showForm,
      editMode,
      fetchFaturas,
      submitForm,
      deleteFatura,
      editFatura,
      resetForm,
      cancelEdit
    };
  }
}).mount('#app');
</script>
</body>
</html>
